<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Minecraft Arch Linux</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f1f5f9;
            --text-muted: #94a3b8;
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --input-bg: #020617;
            --border-color: #334155;
            --radius: 12px;
            --shadow: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
        }
        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            background-color: var(--bg-color);
            background-image: radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%), 
                              radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            color: var(--text-color); 
            margin: 0; 
            padding: 20px; 
            line-height: 1.6;
        }
        h1, h2, h3 { color: #fff; margin-top: 0; font-weight: 700; letter-spacing: -0.025em; }
        h1 { text-align: center; margin-bottom: 40px; letter-spacing: -0.5px; }
        
        .container { max-width: 1100px; margin: 0 auto; }
        
        .panel { 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: var(--radius); 
            margin-bottom: 30px; 
            border: 1px solid var(--border-color); 
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
        }

        input, button, select { 
            padding: 12px 16px; 
            margin: 8px 0; 
            border-radius: 8px;
            border: 1px solid var(--border-color); 
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }
        input, select, textarea { background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        
        button { 
            cursor: pointer; 
            background: var(--primary-color); 
            color: white; 
            font-weight: 600; 
            border: none; 
            width: auto; 
            display: inline-block; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        button:hover { background: var(--primary-hover); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button.stop { background: var(--danger-color); color: #000; }
        button.stop:hover { background: #dc2626; }
        
        #console { 
            background: #0f172a; color: #22c55e; font-family: 'JetBrains Mono', 'Consolas', monospace; 
            height: 400px; overflow-y: scroll; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); 
            white-space: pre-wrap;
            font-size: 13px;
            line-height: 1.4;
            box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.5);
        }
        .control-group { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 15px; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        
        /* Estilos para botones de servidores */
        #serverList button {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            flex: 1 1 200px;
            height: 120px;
            font-size: 1.1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        #serverList button:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.3);
            border-color: var(--primary-color);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Estilos Inventario */
        .inv-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 4px; background: #94a3b8; padding: 10px; border: 4px solid #475569; width: fit-content; margin: 0 auto; border-radius: 4px; }
        .inv-slot { width: 36px; height: 36px; background: #64748b; border: 2px solid #334155; border-right-color: #cbd5e1; border-bottom-color: #cbd5e1; position: relative; display: flex; align-items: center; justify-content: center; }
        .inv-slot:hover { background: #a0a0a0; }
        .inv-item-count { position: absolute; bottom: 0; right: 2px; color: white; font-size: 10px; font-weight: bold; text-shadow: 1px 1px 0 #000; }
        .inv-tooltip { display: none; position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 5px; border-radius: 4px; font-size: 12px; z-index: 10; white-space: nowrap; pointer-events: none; border: 1px solid #5500aa; }
        .inv-slot:hover .inv-tooltip { display: block; top: -30px; left: 50%; transform: translateX(-50%); }
        
        .stats-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        .stats-table td { padding: 8px; border-bottom: 1px solid var(--border-color); }
        .stats-table tr:last-child td { border-bottom: none; }

        /* Layout Detalles Jugador */
        .pd-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .pd-col { flex: 1; min-width: 300px; }
        .pd-inv { min-width: 390px; } /* Evita solapamiento con el grid fijo */

        /* Botones de navegaci√≥n del servidor */
        .nav-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 20px; }
        .nav-btn {
            height: 120px; font-size: 1em; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; background: var(--card-bg); 
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            color: var(--text-color);
            transition: all 0.2s;
            box-shadow: var(--shadow);
            font-weight: 500;
        }
        .nav-btn:hover { background: #334155; transform: translateY(-3px); border-color: var(--primary-color); }
        .view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }

        /* Tablas Modernas */
        .modern-table { width: 100%; border-collapse: collapse; color: var(--text-color); }
        .modern-table th { text-align: left; padding: 12px; background: #0f172a; border-bottom: 2px solid var(--border-color); font-weight: 600; }
        .modern-table td { padding: 12px; border-bottom: 1px solid var(--border-color); }
        .modern-table tr:hover td { background: rgba(255,255,255,0.02); }

        /* Animaciones */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .view-animate { animation: fadeIn 0.3s ease-out; }

        /* --- Dise√±o Responsive (M√≥vil) --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .panel { padding: 15px; }
            h1 { font-size: 1.5rem; margin-bottom: 20px; }
            
            /* Botones m√°s grandes y f√°ciles de tocar (2 por fila) */
            .control-group { gap: 8px; }
            .control-group button { flex: 1 1 45%; padding: 12px 5px; font-size: 13px; }
            
            /* Ajustar vistas para pantallas peque√±as */
            #statsModal > div, #whitelistModal > div, #playerDetailsModal > div {
                width: 92% !important;
                margin: 10px auto !important;
                padding: 15px !important;
                max-width: none !important;
            }

            /* Inventario adaptable */
            .inv-grid { width: 100%; box-sizing: border-box; gap: 2px; padding: 5px; }
            .inv-slot { width: auto; height: auto; aspect-ratio: 1 / 1; }
            .inv-item-count { font-size: 9px; right: 1px; }

            /* Stackear columnas en m√≥vil */
            .pd-col, .pd-inv { min-width: 100% !important; }
        }

        /* Estilos Vitals Jugador */
        .vital-card { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; text-align: center; flex: 1; border: 1px solid var(--border-color); min-width: 80px; }
        .xp-bar { height: 12px; background: #1e293b; border: 1px solid #334155; border-radius: 6px; overflow: hidden; margin-top: 5px; position: relative; }
        .xp-fill { height: 100%; background: linear-gradient(180deg, #2b9f2b, #1a6b1a); width: 0%; transition: width 0.5s; }
        .xp-text { position: absolute; width: 100%; text-align: center; font-size: 9px; line-height: 12px; color: #fff; text-shadow: 1px 1px 0 #000; top: 0; }

        /* --- Bottom Dock Style (Estilo Aternos M√≥vil) --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1e293b; /* var(--card-bg) */
            border-top: 1px solid #334155; /* var(--border-color) */
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 9999;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
        }
        
        .nav-item {
            background: transparent !important;
            box-shadow: none !important;
            border: none !important;
            color: #94a3b8; /* var(--text-muted) */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            padding: 4px;
            margin: 0;
            width: auto;
            flex: 1;
        }
        
        .nav-item:hover { transform: none !important; color: #f1f5f9; }
        .nav-item.active { color: #3b82f6; /* var(--primary-color) */ }
        
        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
            display: block;
        }

        /* Ajustar padding del body para que el dock no tape contenido */
        body { padding-bottom: 90px; }
        
        /* Ocultar la cuadr√≠cula de navegaci√≥n antigua */
        .nav-grid { display: none !important; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
</head>
<body>
    <div class="container">
    <h1>Panel de Control (Arch Linux)</h1>

    <!-- VISTA: DASHBOARD (Lista de Servidores) -->
    <div id="dashboardView" class="view-animate">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h2 style="margin:0;">Mis Servidores</h2>
                <button onclick="showPluginsView()" style="background: #475569; width: auto; margin-right: 10px;">üß© Plugins</button>
                <button onclick="showSecurityView()" style="background: #475569; width: auto; margin-right: 10px;">üõ°Ô∏è Seguridad</button>
                <button onclick="showCreateView()" style="background: var(--success-color); width: auto; padding: 10px 20px;">+ Crear Nuevo</button>
            </div>
            <div id="serverList" style="display: flex; gap: 15px; flex-wrap: wrap;">
                <p>Cargando servidores...</p>
            </div>
        </div>
    </div>

    <!-- VISTA: CREAR (Formulario) -->
    <div id="createView" style="display:none;" class="view-animate">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h2 style="margin:0;">Crear Nuevo Servidor</h2>
                <button onclick="showDashboard()" style="background: #475569; width: auto;">&larr; Cancelar</button>
            </div>
            <input type="text" id="serverName" placeholder="Nombre (ej: survival)">
            <input type="number" id="serverPort" placeholder="Puerto (ej: 25565)" value="25565">
            <input type="number" id="serverBedrockPort" placeholder="Puerto Bedrock UDP (ej: 19132)" value="19132">
            <input type="text" id="serverRam" placeholder="RAM (ej: 2G)" value="2G">
            
            <label style="display:block; margin-top:10px; color:var(--text-muted); font-size:0.9em;">Tipo de Servidor:</label>
            <select id="serverType" onchange="checkServerType()" style="width: 100%;">
                <option value="PAPER">Paper (Plugins - Recomendado)</option>
                <option value="PURPUR">Purpur (Plugins - Muy Optimizado)</option>
                <option value="SPIGOT">Spigot (Plugins Cl√°sico)</option>
                <option value="FORGE">Forge (Mods)</option>
                <option value="FABRIC">Fabric (Mods Ligeros)</option>
                <option value="NEOFORGE">NeoForge (Fork de Forge)</option>
                <option value="MAGMA">Magma (Mods + Plugins)</option>
                <option value="MOHIST">Mohist (Mods + Plugins)</option>
                <option value="ARCLIGHT">Arclight (Mods + Plugins)</option>
                <option value="VANILLA">Vanilla (Original)</option>
                <option value="VELOCITY">Velocity (Proxy Moderno - Recomendado)</option>
                <option value="WATERFALL">Waterfall (Proxy Cl√°sico)</option>
                <option value="BUNGEECORD">BungeeCord (Proxy Original)</option>
            </select>
            
            <div id="fabricLoaderField" style="display:none;">
                <label style="display:block; margin-top:10px; color:var(--text-muted); font-size:0.9em;">Versi√≥n de Fabric Loader:</label>
                <select id="serverLoaderVersion" style="width: 100%;"></select>
            </div>

            <label style="display:block; margin-top:10px; color:var(--text-muted); font-size:0.9em;">Versi√≥n de Minecraft:</label>
            <input type="text" id="serverVersion" list="commonVersions" placeholder="Escribe la versi√≥n (ej: 1.20.1) o selecciona" value="LATEST" style="width: 100%; box-sizing: border-box;">
            <datalist id="commonVersions">
                <option value="LATEST">√öltima Versi√≥n Estable</option>
                <option value="1.21.1">1.21.1 (Tricky Trials)</option>
                <option value="1.21">1.21</option>
                <option value="1.20.6">1.20.6 (Armored Paws)</option>
                <option value="1.20.4">1.20.4 (Trails & Tales)</option>
                <option value="1.20.1">1.20.1 (Popular)</option>
                <option value="1.19.4">1.19.4 (The Wild Update)</option>
                <option value="1.19.2">1.19.2</option>
                <option value="1.18.2">1.18.2 (Caves & Cliffs II)</option>
                <option value="1.17.1">1.17.1 (Caves & Cliffs I)</option>
                <option value="1.16.5">1.16.5 (Nether Update - Mods)</option>
                <option value="1.15.2">1.15.2 (Buzzy Bees)</option>
                <option value="1.14.4">1.14.4 (Village & Pillage)</option>
                <option value="1.13.2">1.13.2 (Update Aquatic)</option>
                <option value="1.12.2">1.12.2 (Classic Mods)</option>
                <option value="1.8.9">1.8.9 (PvP Legacy)</option>
                <option value="1.7.10">1.7.10 (Legendary Mods)</option>
            </datalist>
            <small style="color: var(--text-muted); display: block; margin-top: 4px; font-size: 0.8em;">‚ÑπÔ∏è Se descargar√° la √∫ltima compilaci√≥n (build) disponible para la versi√≥n elegida.</small>

            <button onclick="createServer()">Crear Servidor</button>
        </div>
    </div>

    <!-- VISTA: MENU DEL SERVIDOR (Home) -->
    <div id="manageView" style="display:none;" class="view-animate">
        <div class="view-header">
            <div>
                <h2 id="controlTitle" style="margin:0;">Gestionando Servidor</h2>
                <div id="portDisplay" style="color: var(--primary-color); font-weight: bold; font-size: 0.9em;"></div>
            </div>
            <button onclick="showDashboard()" style="background: #475569; width: auto;">&larr; Volver a Mis Servidores</button>
        </div>

        <input type="hidden" id="containerId">

        <!-- Panel de Control Unificado -->
        <div class="panel">
            <!-- Mini Stats (Nuevo) -->
            <div style="display: flex; justify-content: center; gap: 40px; margin-bottom: 25px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                <div style="text-align: center;">
                    <div style="color: var(--text-muted); font-size: 0.8em; margin-bottom: 5px;">CPU</div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #00d8ff;"><span id="miniCpu">0</span>%</div>
                </div>
                <div style="width: 1px; background: var(--border-color);"></div>
                <div style="text-align: center;">
                    <div style="color: var(--text-muted); font-size: 0.8em; margin-bottom: 5px;">RAM</div>
                    <div style="font-size: 1.5em; font-weight: bold; color: #4CAF50;"><span id="miniRam">0</span> MB</div>
                </div>
            </div>

            <!-- Secci√≥n Energ√≠a -->
            <div style="margin-bottom: 25px;">
                <h3 style="text-align: center; margin-bottom: 15px; font-size: 1.1rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Control de Energ√≠a</h3>
                <div class="control-group" style="justify-content: center; gap: 10px;">
                    <button onclick="startServer()" style="flex: 1; padding: 15px; font-size: 1.1em;">Iniciar üü¢</button>
                    <button onclick="restartServer()" style="flex: 1; background: var(--warning-color); padding: 15px; font-size: 1.1em;">Reiniciar üîÑ</button>
                    <button onclick="stopServer()" class="stop" style="flex: 1; padding: 15px; font-size: 1.1em;">Detener üî¥</button>
                </div>
                <div style="text-align: right; margin-top: 5px;">
                    <button onclick="killServer()" style="background: transparent; border: none; color: var(--danger-color); font-size: 0.8em; width: auto; box-shadow: none; padding: 5px; text-decoration: underline;">‚ö†Ô∏è Forzar Detenci√≥n</button>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 20px 0;">

            <!-- Secci√≥n Herramientas -->
            <div>
                <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Herramientas R√°pidas</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <button onclick="createLocalBackup()" style="background: #e67e22; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px;">
                        <span style="font-size: 1.2em;">üì¶</span> Backup
                    </button>
                    <button onclick="showServerView('fileManagerView'); openFileManager(); enterDirectory('backups');" style="background: #334155; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px;">
                        <span style="font-size: 1.2em;">üìÇ</span> Archivos
                    </button>
                    <button onclick="showUpdateModal()" style="background: var(--primary-color); display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px;">
                        <span style="font-size: 1.2em;">üîÑ</span> Actualizar
                    </button>
                    <button onclick="showServerView('statsView'); openStats();" style="background: #475569; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px;">
                        <span style="font-size: 1.2em;">üìà</span> Gr√°ficas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA: CONSOLA -->
    <div id="consoleView" style="display:none;" class="view-animate">
        <div class="view-header">
            <h2>Consola en Vivo</h2>
            <button onclick="showServerView('manageView')" style="background: #475569; width: auto;">&larr; Volver</button>
        </div>
        <div class="panel">
            <div id="console"></div>
            <div class="control-group">
                <input type="text" id="commandInput" placeholder="Comando (ej: /op usuario)" style="flex-grow: 1;" onkeydown="if(event.key==='Enter') sendCommand()">
                <button onclick="sendCommand()">Enviar</button>
            </div>

            <!-- Stats en Consola (2 Cuadros) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); text-align: center;">
                    <div style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 5px;">Uso de CPU</div>
                    <div style="font-size: 1.4em; font-weight: bold; color: #00d8ff;"><span id="consoleCpu">0</span>%</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); text-align: center;">
                    <div style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 5px;">Uso de RAM</div>
                    <div style="font-size: 1.4em; font-weight: bold; color: #4CAF50;"><span id="consoleRam">0</span> MB</div>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA: JUGADORES Y WHITELIST -->
    <div id="playersView" style="display:none;" class="view-animate">
        <div class="view-header">
            <h2>Gesti√≥n de Jugadores</h2>
            <button onclick="showServerView('manageView')" style="background: #475569; width: auto;">&larr; Volver</button>
        </div>
        
        <div class="pd-container">
            <!-- Columna Jugadores Online -->
            <div class="pd-col panel">
                <h3>En L√≠nea (<span id="playerCount">0/0</span>)</h3>
                <ul id="playerListDisplay" style="list-style: none; padding: 0;"><li>Cargando...</li></ul>
            </div>

            <!-- Columna Whitelist -->
            <div class="pd-col panel">
                <h3>Whitelist</h3>
                <div style="display:flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="sendWhitelistCmd('on')" style="background: var(--success-color); flex: 1;">Activar ‚úÖ</button>
                    <button onclick="sendWhitelistCmd('off')" style="background: var(--danger-color); flex: 1;">Desactivar ‚ùå</button>
                </div>
                <div style="display:flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="whitelistInput" placeholder="Nombre (ej: Steve)" style="flex-grow: 1;">
                    <button onclick="addWhitelistPlayer()" style="width: auto; background: var(--primary-color);">A√±adir</button>
                </div>
                <ul id="whitelistDisplay" style="list-style: none; padding: 0; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 4px; min-height: 200px; max-height: 400px; overflow-y: auto;"></ul>
            </div>
        </div>
    </div>

    <!-- VISTA: ESTAD√çSTICAS (Antes Modal) -->
    <div id="statsView" style="display:none;" class="view-animate">
        <div class="view-header">
                <h2 style="margin:0;">Monitor de Rendimiento</h2>
                <button onclick="showServerView('manageView')" style="background: #475569; width: auto;">&larr; Volver</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr; gap: 20px;">
                <div class="panel">
                    <h3>Uso de CPU (%)</h3>
                    <div class="chart-container">
                        <canvas id="cpuChart"></canvas>
                    </div>
                </div>
                <div class="panel">
                    <h3>Uso de RAM (MB)</h3>
                    <div class="chart-container">
                        <canvas id="ramChart"></canvas>
                    </div>
                </div>
        </div>
    </div>

    <!-- Update Server Modal -->
    <div id="updateServerModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index:2000; align-items:center; justify-content:center;">
        <div style="background: var(--card-bg); padding: 30px; border-radius: var(--radius); width: 90%; max-width: 400px; border: 1px solid var(--border-color); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5);">
            <h2 style="margin-top:0;">Actualizar Servidor</h2>
            <p style="color: var(--text-muted); font-size: 0.9em;">Esto detendr√° el servidor, descargar√° la nueva versi√≥n y lo reiniciar√°. ¬°Haz un backup antes!</p>
            
            <label style="display:block; margin-top:10px;">Tipo:</label>
            <select id="updateType">
                <option value="PAPER">Paper</option>
                <option value="PURPUR">Purpur</option>
                <option value="SPIGOT">Spigot</option>
                <option value="FABRIC">Fabric</option>
                <option value="FORGE">Forge</option>
                <option value="VANILLA">Vanilla</option>
                <option value="VELOCITY">Velocity</option>
            </select>

            <label style="display:block; margin-top:10px;">Versi√≥n:</label>
            <input type="text" id="updateVersion" placeholder="Ej: 1.20.4 o LATEST" value="LATEST">

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="confirmUpdate()" style="background: var(--warning-color); color: #000;">Confirmar Actualizaci√≥n</button>
                <button onclick="document.getElementById('updateServerModal').style.display='none'" style="background: #475569;">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Player Details Modal -->
    <div id="playerDetailsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index:2000; overflow-y:auto;">
        <div style="padding:20px; max-width: 800px; margin: 50px auto; background: var(--card-bg); border-radius: var(--radius); border: 1px solid var(--border-color); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                <h2 style="margin:0;" id="detailsTitle">Detalles del Jugador</h2>
                <button onclick="closePlayerDetails()" style="background:var(--danger-color); padding: 5px 10px;">Cerrar X</button>
            </div>
            
            <!-- Panel de Vitals y Acciones -->
            <div style="margin-bottom: 20px;">
                <!-- Vitals -->
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div class="vital-card">
                        <div style="font-size: 1.5em;">‚ù§Ô∏è <span id="pHealth">20</span></div>
                        <small style="color: var(--text-muted);">Salud</small>
                    </div>
                    <div class="vital-card">
                        <div style="font-size: 1.5em;">üçó <span id="pFood">20</span></div>
                        <small style="color: var(--text-muted);">Saturaci√≥n: <span id="pSat">0</span></small>
                    </div>
                    <div class="vital-card" style="flex: 2; min-width: 200px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="color: #55ff55; font-weight: bold;">Nivel <span id="pXpLvl">0</span></span>
                            <small style="color: var(--text-muted);">Total XP: <span id="pXpTotal">0</span></small>
                        </div>
                        <div class="xp-bar"><div id="pXpBar" class="xp-fill"></div><div id="pXpText" class="xp-text">0%</div></div>
                        <small style="color: var(--text-muted); font-size: 0.8em;">Falta <span id="pXpMissing">0%</span> para el siguiente</small>
                    </div>
                </div>

                <!-- Acciones R√°pidas -->
                <div id="playerActionsBar" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
            </div>

            <div class="pd-container">
                <div class="pd-col pd-inv">
                    <!-- Armadura y Mano Secundaria -->
                    <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 15px;">
                        <div>
                            <h4 style="text-align: center; margin: 0 0 5px 0;">Armadura</h4>
                            <div id="armorGrid" style="display: flex; gap: 4px;"></div>
                        </div>
                        <div>
                            <h4 style="text-align: center; margin: 0 0 5px 0;">Mano Sec.</h4>
                            <div id="offhandGrid" style="display: flex; gap: 4px;"></div>
                        </div>
                    </div>

                    <h3 style="text-align: center;">Inventario</h3>
                    <div id="inventoryGrid" class="inv-grid"></div>
                    
                    <h3 style="text-align: center; margin-top: 20px;">Ender Chest</h3>
                    <div id="enderGrid" class="inv-grid"></div>
                </div>
                
                <div class="pd-col" style="background: var(--input-bg); padding: 15px; border-radius: 8px; max-height: 500px; overflow-y: auto; border: 1px solid var(--border-color);">
                    <h3 style="margin-top: 0;">Estad√≠sticas</h3>
                    <table class="stats-table">
                        <tbody id="statsBody"></tbody>
                    </table>
                </div>
            </div>
            <p style="text-align: center; color: var(--text-muted); font-size: 0.8em; margin-top: 10px;">Actualizando autom√°ticamente cada minuto...</p>
        </div>
    </div>

    <!-- VISTA: CONFIGURACI√ìN (Antes Modal) -->
    <div id="configView" style="display:none;" class="view-animate">
        <div class="view-header">
                <h2 style="margin:0;" id="editorTitle">Editando: server.properties</h2>
                <div>
                    <button onclick="saveFile()" style="background:var(--success-color); padding: 5px 15px; margin-right: 10px;">Guardar üíæ</button>
                    <button onclick="showServerView('manageView')" style="background: #475569; width: auto;">&larr; Volver</button>
                </div>
        </div>
        <div id="fileEditorContent" style="width: 100%; height: 60vh; margin-bottom: 20px; border-radius: 8px; border: 1px solid var(--border-color);"></div>
        
        <div class="panel" style="border: 1px solid var(--danger-color); background: rgba(239, 68, 68, 0.05);">
            <h3 style="color: var(--danger-color); margin-top: 0;">Zona de Peligro</h3>
            <p style="color: var(--text-muted); font-size: 0.9em;">Estas acciones son destructivas y no se pueden deshacer.</p>
            <button onclick="deleteServer()" style="background: var(--danger-color); width: auto;">üóëÔ∏è Eliminar Servidor Permanentemente</button>
        </div>
    </div>

    <!-- VISTA: ARCHIVOS (Antes Modal) -->
    <div id="fileManagerView" style="display:none;" class="view-animate">
        <div class="view-header">
            <h2 style="margin:0;">Archivos <span id="fileManagerPath" style="font-size: 0.6em; color: var(--text-muted); font-weight: normal;">/</span></h2>
            <div style="display: flex; gap: 10px;">
                <button onclick="downloadBackup()" style="background: #5d4037; width: auto; font-size: 0.8em; padding: 8px;">üì¶ Zip</button>
                <button onclick="downloadLogs()" style="background: #475569; width: auto; font-size: 0.8em; padding: 8px;">üì• Logs</button>
                <button onclick="showServerView('manageView')" style="background: #475569; width: auto;">&larr; Volver</button>
            </div>
        </div>

        <div class="panel" style="margin-top: 20px;">

            <!-- Upload Area -->
            <div id="dropZone" onclick="document.getElementById('fileInput').click()" style="border: 2px dashed var(--border-color); padding: 30px; text-align: center; margin-bottom: 20px; cursor: pointer; color: var(--text-muted); transition: 0.2s; background: rgba(0,0,0,0.2); border-radius: 8px;">
                <p style="margin:0; font-size: 1.1em;">‚òÅÔ∏è Arrastra archivos aqu√≠ o haz clic para subir</p>
                <p style="margin:5px 0 0 0; font-size: 0.8em; color: var(--text-muted);">(Mods, Plugins, Mundos, Configs)</p>
                <input type="file" id="fileInput" multiple style="display:none;" onchange="handleFiles(this.files)">
            </div>

            <!-- Barra de Progreso -->
            <div id="uploadProgressContainer" style="display:none; margin-bottom: 20px; background: var(--input-bg); border-radius: 4px; overflow: hidden;">
                <div id="uploadProgressBar" style="width: 0%; height: 10px; background: var(--success-color); transition: width 0.2s;"></div>
            </div>

            <!-- File List -->
            <div style="background: var(--input-bg); border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color);">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th style="text-align: right;">Tama√±o</th>
                            <th style="text-align: right;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="fileListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- VISTA: SEGURIDAD PANEL -->
    <div id="securityView" style="display:none;" class="view-animate">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h2 style="margin:0;">Seguridad del Panel</h2>
                <button onclick="showDashboard()" style="background: #475569; width: auto;">&larr; Volver</button>
            </div>
            
            <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning-color); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="color: var(--warning-color); margin-top: 0;">‚ö†Ô∏è Lista Blanca de IPs</h3>
                <p style="margin: 0; font-size: 0.9em;">Si a√±ades IPs a esta lista, <strong>nadie m√°s podr√° acceder al panel</strong>.</p>
                <p style="margin: 5px 0 0 0; font-size: 0.9em;">Tu IP actual es: <strong id="currentIpDisplay">Detectando...</strong> <button onclick="addCurrentIp()" style="padding: 2px 8px; font-size: 0.8em; width: auto; margin-left: 10px;">‚ûï A√±adir mi IP</button></p>
            </div>

            <div style="display:flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="newAllowedIp" placeholder="Ej: 192.168.1.50" style="flex-grow: 1;">
                <button onclick="addAllowedIp()" style="width: auto; background: var(--success-color);">A√±adir IP</button>
            </div>

            <ul id="allowedIpList" style="list-style: none; padding: 0; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 4px; min-height: 50px;"></ul>
            <p style="color: var(--text-muted); font-size: 0.8em;">* Si borras todas las IPs, la protecci√≥n se desactiva y cualquiera con la contrase√±a podr√° entrar.</p>
        </div>
    </div>

    <!-- VISTA: GESTI√ìN DE PLUGINS -->
    <div id="pluginsView" style="display:none;" class="view-animate">
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <h2 style="margin:0;">Plugins del Sistema</h2>
                <button onclick="showDashboard()" style="background: #475569; width: auto;">&larr; Volver</button>
            </div>
            <p style="color: var(--text-muted); margin-bottom: 20px;">Aqu√≠ puedes configurar los plugins instalados en la carpeta <code>plugins/</code>.</p>
            <div id="pluginsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                <!-- Se llena con JS -->
            </div>
        </div>
    </div>

    <!-- Notificaciones Toast -->
    <div id="toast-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 3000;"></div>

    <!-- BOTTOM DOCK NAVIGATION -->
    <div id="bottomNav" class="bottom-nav" style="display:none;">
        <button class="nav-item" id="nav-manageView" onclick="showServerView('manageView')">
            <span class="nav-icon">üè†</span>
            <span>Server</span>
        </button>
        <button class="nav-item" id="nav-consoleView" onclick="showServerView('consoleView'); connectConsole();">
            <span class="nav-icon">üì∫</span>
            <span>Consola</span>
        </button>
        <button class="nav-item" id="nav-playersView" onclick="showServerView('playersView'); updatePlayerList(); loadWhitelist();">
            <span class="nav-icon">üë•</span>
            <span>Jugadores</span>
        </button>
        <button class="nav-item" id="nav-fileManagerView" onclick="showServerView('fileManagerView'); openFileManager();">
            <span class="nav-icon">üìÇ</span>
            <span>Archivos</span>
        </button>
        <button class="nav-item" id="nav-configView" onclick="showServerView('configView'); openProperties();">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>Opciones</span>
        </button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const consoleDiv = document.getElementById('console');
        let cpuChart, ramChart;
        let currentServerPort = null;
        let playerInterval = null;
        let currentServerName = '';
        let lastNotificationTime = 0;
        let detailsInterval = null;
        let currentPlayerDetails = null;
        const serverViews = ['manageView', 'consoleView', 'playersView', 'fileManagerView', 'configView', 'statsView', 'securityView', 'pluginsView'];
        let editor; // Ace Editor instance

        async function createServer() {
            const name = document.getElementById('serverName').value;
            const port = document.getElementById('serverPort').value;
            const bedrockPort = document.getElementById('serverBedrockPort').value;
            const ram = document.getElementById('serverRam').value;
            const type = document.getElementById('serverType').value;
            const version = document.getElementById('serverVersion').value;
            const loader = document.getElementById('serverLoaderVersion').value;

            const res = await fetch('/create-server', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ serverName: name, port, bedrockPort, ramLimit: ram, serverType: type, serverVersion: version, loaderVersion: loader })
            });
            const data = await res.json();
            showToast(data.message || data.error, res.ok ? 'success' : 'error');
            showDashboard(); // Volver al dashboard para ver el nuevo servidor
        }

        async function startServer() {
            const id = document.getElementById('containerId').value;
            consoleDiv.innerHTML = "Iniciando servidor...\n";
            const res = await fetch(`/start-server/${id}`, { method: 'POST' });
            const data = await res.json();
            showToast(data.message || data.error, res.ok ? 'success' : 'error');
            loadServers(); // Actualizar estado (verde/rojo)
            if(res.ok) connectConsole(); // Reconectar consola autom√°ticamente
        }

        async function stopServer() {
            const id = document.getElementById('containerId').value;
            const res = await fetch(`/stop-server/${id}`, { method: 'POST' });
            const data = await res.json();
            showToast(data.message || data.error, res.ok ? 'success' : 'error');
            loadServers(); // Actualizar estado
        }

        async function restartServer() {
            const id = document.getElementById('containerId').value;
            consoleDiv.innerHTML = "Reiniciando servidor...\n";
            const res = await fetch(`/restart-server/${id}`, { method: 'POST' });
            const data = await res.json();
            showToast(data.message || data.error, res.ok ? 'success' : 'error');
            loadServers();
            if(res.ok && document.getElementById('consoleView').style.display !== 'none') connectConsole();
        }

        async function killServer() {
            if(!confirm("‚ö†Ô∏è ¬øForzar cierre (KILL)?\n\n√ösalo solo si el servidor est√° congelado. Podr√≠a corromper datos.")) return;
            

            const id = document.getElementById('containerId').value;
            const res = await fetch(`/kill-server/${id}`, { method: 'POST' });
            const data = await res.json();
            

            showToast(data.message || data.error, res.ok ? 'success' : 'error');
            loadServers();
        }

        async function deleteServer() {
            if(!confirm("‚ö†Ô∏è ¬øEST√ÅS SEGURO?\n\nEsto eliminar√° el servidor, el mundo y todos los archivos PERMANENTEMENTE.\n\nEsta acci√≥n no se puede deshacer.")) return;
            

            const id = document.getElementById('containerId').value;
            const res = await fetch(`/delete-server/${id}`, { method: 'DELETE' });
            const data = await res.json();
            

            showToast(data.message || data.error, res.ok ? 'success' : 'error');
            showDashboard(); // Volver al dashboard
            loadServers();
        }

        function showUpdateModal() {
            document.getElementById('updateServerModal').style.display = 'flex';
        }

        async function confirmUpdate() {
            const id = document.getElementById('containerId').value;
            const type = document.getElementById('updateType').value;
            const version = document.getElementById('updateVersion').value;
            
            if(!confirm("¬øHiciste un backup? El servidor se reiniciar√° y se descargar√°n los nuevos archivos.")) return;

            document.getElementById('updateServerModal').style.display = 'none';
            showToast("‚è≥ Iniciando actualizaci√≥n...", "info");

            try {
                const res = await fetch(`/update-server/${id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ version, type })
                });
                const data = await res.json();
                showToast(data.message || data.error, res.ok ? 'success' : 'error');
                if(res.ok) {
                    loadServers();
                    connectConsole();
                }
            } catch (e) {
                showToast("Error de conexi√≥n", "error");
            }
        }

        async function createLocalBackup() {
            const id = document.getElementById('containerId').value;
            if(!id) return;
            
            // Feedback inmediato
            showToast("‚è≥ Creando backup... esto puede tardar unos segundos.", "info");
            
            try {
                const res = await fetch(`/local-backup/${id}`, { method: 'POST' });
                const data = await res.json();
                showToast(data.message || data.error, res.ok ? 'success' : 'error');
            } catch (e) {
                showToast("Error de conexi√≥n", "error");
            }
        }

        function downloadLogs() {
            const id = document.getElementById('containerId').value;
            if(!id) return showToast("No hay servidor seleccionado", "error");
            window.location.href = `/download-logs/${id}`;
        }

        function downloadBackup() {
            if(!currentServerName) return showToast("No hay servidor seleccionado", "error");
            window.location.href = `/backup/${currentServerName}`;
        }

        function openProperties() {
            if(!currentServerName) return showToast("No hay servidor seleccionado", "error");
            loadEditorContent(currentServerName, 'server.properties');
        }

        function connectConsole() {
            const id = document.getElementById('containerId').value;
            
            if(!id) return;

            consoleDiv.innerHTML = "Conectando a logs...\n";
            socket.emit('attach-console', id);
            socket.emit('attach-stats', id);

            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        socket.on('console-output', (data) => {
            // Detectar si el usuario est√° al final del scroll (Smart Autoscroll)
            // Usamos un margen de 50px por si no est√° exactamente en el pixel final
            const isAtBottom = consoleDiv.scrollHeight - consoleDiv.scrollTop <= consoleDiv.clientHeight + 50;

            // Optimizaci√≥n: Usar insertAdjacentText es mucho m√°s r√°pido que innerHTML +=
            consoleDiv.insertAdjacentText('beforeend', data);
            
            // Limitar la cantidad de texto en memoria para evitar que el navegador se congele
            if (consoleDiv.textContent.length > 100000) {
                consoleDiv.textContent = consoleDiv.textContent.substring(consoleDiv.textContent.length - 50000);
            }
            
            // Solo bajar si el usuario estaba viendo lo √∫ltimo (Smart Scroll)
            if (isAtBottom) {
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }
        });

        // Reconexi√≥n autom√°tica si se cae la conexi√≥n (ej: reinicio del panel)
        socket.on('connect', () => {
            const id = document.getElementById('containerId').value;
            if (id && document.getElementById('consoleView').style.display !== 'none') {
                socket.emit('attach-console', id);
                socket.emit('attach-stats', id);
            }
        });

        socket.on('stats-update', (data) => {
            const memUsed = (data.memory / 1024 / 1024).toFixed(1);
            const memLimit = (data.memoryLimit / 1024 / 1024).toFixed(1);
            
            // Actualizar Mini Stats
            const miniCpu = document.getElementById('miniCpu');
            const miniRam = document.getElementById('miniRam');
            if(miniCpu) miniCpu.innerText = data.cpu;
            if(miniRam) miniRam.innerText = Math.round(memUsed);

            // Actualizar Stats en Consola
            const conCpu = document.getElementById('consoleCpu');
            const conRam = document.getElementById('consoleRam');
            if(conCpu) conCpu.innerText = data.cpu;
            if(conRam) conRam.innerText = Math.round(memUsed);

            updateCharts(data.cpu, memUsed);

            // Alerta de RAM > 90%
            if (data.memoryLimit > 0) {
                const percentage = (data.memory / data.memoryLimit) * 100;
                if (percentage > 90 && (Date.now() - lastNotificationTime > 60000)) {
                    showNotification(`‚ö†Ô∏è ALERTA CR√çTICA`, `RAM al ${percentage.toFixed(1)}% (${memUsed}MB)`);
                    lastNotificationTime = Date.now();
                }
            }
        });

        function sendCommand() {
            const input = document.getElementById('commandInput');
            socket.emit('send-command', input.value);
            input.value = '';
        }

        // --- L√≥gica de Gr√°ficas ---
        function initCharts() {
            if(cpuChart) return; // Evitar recrear si ya existen

            Chart.defaults.color = '#eee';
            Chart.defaults.borderColor = '#444';

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: false, // Desactivar animaci√≥n para mejor rendimiento en laptop vieja
                scales: {
                    x: { grid: { color: '#333' } },
                    y: { grid: { color: '#333' }, beginAtZero: true }
                },
                elements: { point: { radius: 0 } } // Ocultar puntos para que se vea m√°s limpio
            };

            cpuChart = new Chart(document.getElementById('cpuChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'CPU %', data: [], borderColor: '#00d8ff', backgroundColor: 'rgba(0, 216, 255, 0.1)', fill: true, tension: 0.3 }] },
                options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, max: 100 } } }
            });

            ramChart = new Chart(document.getElementById('ramChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'RAM (MB)', data: [], borderColor: '#4CAF50', backgroundColor: 'rgba(76, 175, 80, 0.1)', fill: true, tension: 0.3 }] },
                options: commonOptions
            });
        }

        function updateCharts(cpu, ram) {
            // Solo actualizar si la vista de gr√°ficas est√° abierta
            if(!cpuChart || document.getElementById('statsView').style.display === 'none') return;

            const now = new Date().toLocaleTimeString();
            
            // Mantener solo los √∫ltimos 50 puntos de datos
            if(cpuChart.data.labels.length > 50) {
                cpuChart.data.labels.shift();
                cpuChart.data.datasets[0].data.shift();
                ramChart.data.labels.shift();
                ramChart.data.datasets[0].data.shift();
            }

            cpuChart.data.labels.push(now);
            cpuChart.data.datasets[0].data.push(cpu);
            ramChart.data.labels.push(now);
            ramChart.data.datasets[0].data.push(ram);

            cpuChart.update();
            ramChart.update();
        }

        function openStats() {
            initCharts();
        }

        // --- Navegaci√≥n de Vistas ---
        function hideAllViews() {
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('createView').style.display = 'none';
            serverViews.forEach(id => document.getElementById(id).style.display = 'none');
        }

        function showServerView(viewId) {
            hideAllViews();
            document.getElementById(viewId).style.display = 'block';
        }

        function showDashboard() {
            hideAllViews();
            document.getElementById('dashboardView').style.display = 'block';
            loadServers();
        }

        function showCreateView() {
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('createView').style.display = 'block';
            document.getElementById('manageView').style.display = 'none';
            
            // Auto-detectar puertos libres
            detectPorts();
        }

        function showSecurityView() {
            hideAllViews();
            document.getElementById('securityView').style.display = 'block';
            loadAllowedIps();
            
            // Detectar mi IP
            fetch('/my-ip').then(r => r.json()).then(d => {
                document.getElementById('currentIpDisplay').innerText = d.ip;
            });
        }

        function showPluginsView() {
            hideAllViews();
            document.getElementById('pluginsView').style.display = 'block';
            loadPluginsList();
        }

        async function loadPluginsList() {
            const list = document.getElementById('pluginsList');
            list.innerHTML = '<p>Cargando...</p>';
            try {
                const res = await fetch('/list-backend-plugins');
                const plugins = await res.json();
                list.innerHTML = '';
                
                if(plugins.length === 0) {
                    list.innerHTML = '<p style="color:var(--text-muted);">No hay plugins instalados.</p>';
                    return;
                }

                plugins.forEach(p => {
                    const div = document.createElement('div');
                    div.style.background = 'var(--input-bg)';
                    div.style.padding = '15px';
                    div.style.borderRadius = '8px';
                    div.style.border = '1px solid var(--border-color)';
                    
                    const btn = p.hasConfig 
                        ? `<button onclick="editPluginConfig('${p.name}')" style="margin-top:10px; font-size:0.9em;">‚öôÔ∏è Configurar</button>`
                        : `<button disabled style="margin-top:10px; font-size:0.9em; opacity:0.5; cursor:not-allowed; background:#334155;">Sin Config</button>`;

                    div.innerHTML = `<h3 style="margin:0 0 5px 0;">${p.name}</h3><small style="color:var(--text-muted);">Backend Plugin</small>${btn}`;
                    list.appendChild(div);
                });
            } catch(e) { list.innerHTML = '<p>Error cargando plugins.</p>'; }
        }

        function editPluginConfig(pluginName) {
            showServerView('configView');
            currentEditingFile = `PLUGIN:${pluginName}`; // Marcador especial
            document.getElementById('editorTitle').innerText = `Configurando: ${pluginName}`;
            if(editor) editor.setValue("Cargando...", -1);

            fetch(`/plugin-config/${pluginName}`).then(r => r.json()).then(data => {
                if(data.error) { showToast(data.error, 'error'); showPluginsView(); }
                else if(editor) { editor.setValue(data.content, -1); editor.session.setMode("ace/mode/json"); }
            });
        }

        async function loadAllowedIps() {
            const res = await fetch('/panel-whitelist');
            const ips = await res.json();
            const list = document.getElementById('allowedIpList');
            list.innerHTML = '';
            
            if(ips.length === 0) {
                list.innerHTML = '<li style="padding:15px; color:var(--text-muted); text-align:center;">La lista est√° vac√≠a. La protecci√≥n est√° <strong>DESACTIVADA</strong>.</li>';
            } else {
                ips.forEach(ip => {
                    const li = document.createElement('li');
                    li.style.padding = '10px';
                    li.style.borderBottom = '1px solid var(--border-color)';
                    li.style.display = 'flex';
                    li.style.justifyContent = 'space-between';
                    li.innerHTML = `<span>üåê ${ip}</span> <button onclick="removeAllowedIp('${ip}')" style="background:var(--danger-color); padding:2px 8px; font-size:0.8em; width:auto;">Eliminar</button>`;
                    list.appendChild(li);
                });
            }
        }

        async function addAllowedIp() {
            const ip = document.getElementById('newAllowedIp').value;
            if(!ip) return;
            const res = await fetch('/panel-whitelist', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ ip })
            });
            if(res.ok) { document.getElementById('newAllowedIp').value = ''; loadAllowedIps(); showToast("IP A√±adida", "success"); }
        }

        async function removeAllowedIp(ip) {
            if(!confirm(`¬øEliminar ${ip} de la lista blanca?`)) return;
            const res = await fetch('/panel-whitelist', { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ ip }) });
            if(res.ok) { loadAllowedIps(); showToast("IP Eliminada", "success"); }
        }

        function addCurrentIp() {
            document.getElementById('newAllowedIp').value = document.getElementById('currentIpDisplay').innerText;
        }

        async function detectPorts() {
            const pPort = document.getElementById('serverPort');
            const bPort = document.getElementById('serverBedrockPort');
            
            // Efecto visual de carga
            pPort.style.opacity = '0.5';
            bPort.style.opacity = '0.5';

            try {
                const res = await fetch('/next-ports');
                const data = await res.json();
                pPort.value = data.tcp;
                bPort.value = data.udp;
            } catch (e) {
                console.error("Error detectando puertos:", e);
            } finally {
                pPort.style.opacity = '1';
                bPort.style.opacity = '1';
            }
        }

        function showServerHome() {
            hideAllViews();
            document.getElementById('manageView').style.display = 'block';
        }

        // --- Gesti√≥n de Servidores ---
        async function loadServers() {
            const res = await fetch('/list-servers');
            const servers = await res.json();
            const list = document.getElementById('serverList');
            list.innerHTML = '';
            
            if (servers.length === 0) {
                list.innerHTML = '<p style="color: var(--text-muted);">No tienes servidores creados a√∫n.</p>';
                return;
            }

            servers.forEach(s => {
                const btn = document.createElement('button');
                const isRunning = s.status === 'running';
                const iconUrl = `/server-icon/${s.name}?t=${new Date().getTime()}`; // Evitar cach√©
                btn.innerHTML = `
                    <img src="${iconUrl}" onerror="this.style.display='none'" style="width: 48px; height: 48px; border-radius: 4px; margin-bottom: 8px; object-fit: cover;">
                    <strong>${s.name}</strong><br><small>${isRunning ? 'üü¢ Online' : 'üî¥ Offline'}</small>
                `;
                btn.style.borderColor = isRunning ? 'var(--success-color)' : 'var(--border-color)';
                btn.style.padding = '15px';
                btn.style.minWidth = '120px';
                btn.style.textAlign = 'center';
                btn.onclick = () => selectServer(s.id, s.name, s.port, s.bedrockPort);
                list.appendChild(btn);
            });
        }

        function selectServer(id, name, port, bedrockPort) {
            document.getElementById('containerId').value = id;
            document.getElementById('controlTitle').innerText = `Gestionando: ${name}`;
            const bPort = bedrockPort || '19132';
            document.getElementById('portDisplay').innerHTML = `üîå Java (TCP): <strong>${port}</strong> | üì± Bedrock (UDP): <strong>${bPort}</strong>`;
            
            currentServerName = name;
            currentServerPort = port;
            
            showServerHome(); // Cambiar a vista de gesti√≥n
            // updatePlayerList(); // Ya no es necesario en home, solo en vista jugadores
            
            // Iniciar monitoreo de stats inmediatamente
            socket.emit('attach-stats', id);
            
            // Iniciar intervalo de actualizaci√≥n de jugadores
            if (playerInterval) clearInterval(playerInterval);
            playerInterval = setInterval(updatePlayerList, 5000);
        }

        async function updatePlayerList() {
            if(document.getElementById('playersView').style.display === 'none') return;

            const listDisplay = document.getElementById('playerListDisplay');
            const countDisplay = document.getElementById('playerCount');
            
            if (!currentServerPort) {
                listDisplay.innerHTML = '<li>El servidor est√° apagado o inici√°ndose.</li>';
                countDisplay.innerText = '0/0';
                return;
            }

            const res = await fetch(`/server-status/${currentServerPort}`);
            const data = await res.json();

            if (data.online) {
                countDisplay.innerText = `${data.count}/${data.max}`;
                listDisplay.innerHTML = '';
                if (data.players.length === 0) {
                    listDisplay.innerHTML = '<li style="color: var(--text-muted);">No hay jugadores conectados.</li>';
                } else {
                    data.players.forEach(p => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span>üë§ <strong>${p.name}</strong></span>
                                <div>
                                    <button onclick="openPlayerDetails('${p.name}')" style="padding: 2px 6px; font-size: 0.8em; background: var(--primary-color);">Ver</button>
                                    <button onclick="opPlayer('${p.name}')" style="padding: 2px 6px; font-size: 0.8em; background: var(--warning-color);">OP</button>
                                    <button onclick="banPlayer('${p.name}')" style="padding: 2px 6px; font-size: 0.8em; background: var(--danger-color);">Ban</button>
                                    <button onclick="banIpPlayer('${p.name}')" style="padding: 2px 6px; font-size: 0.8em; background: #b91c1c;">IP-Ban</button>
                                </div>
                            </div>
                        `;
                        li.style.padding = '5px 0';
                        li.style.borderBottom = '1px solid var(--border-color)';
                        listDisplay.appendChild(li);
                    });
                }
            } else {
                listDisplay.innerHTML = '<li style="color: var(--danger-color);">Servidor Offline o no responde.</li>';
                countDisplay.innerText = '0/0';
            }
        }

        // --- Acciones de Jugador (OP, Ban) ---
        function opPlayer(name) { socket.emit('send-command', `op ${name}`); showToast(`Enviado: /op ${name}`, 'success'); }
        function banPlayer(name) { socket.emit('send-command', `ban ${name}`); showToast(`Enviado: /ban ${name}`, 'success'); }
        function banIpPlayer(name) { socket.emit('send-command', `ban-ip ${name}`); showToast(`Enviado: /ban-ip ${name}`, 'success'); }

        // --- Detalles del Jugador (Inventario/Stats) ---
        function openPlayerDetails(playerName) {
            currentPlayerDetails = playerName;
            document.getElementById('detailsTitle').innerText = `Detalles: ${playerName}`;
            document.getElementById('playerDetailsModal').style.display = 'block';
            
            loadPlayerDetails();
            if (detailsInterval) clearInterval(detailsInterval);
            detailsInterval = setInterval(loadPlayerDetails, 60000); // Actualizar cada minuto
        }

        function closePlayerDetails() {
            document.getElementById('playerDetailsModal').style.display = 'none';
            if (detailsInterval) clearInterval(detailsInterval);
            currentPlayerDetails = null;
        }

        async function loadPlayerDetails() {
            if (!currentPlayerDetails || !currentServerName) return;
            
            const res = await fetch(`/player-details/${currentServerName}/${currentPlayerDetails}`);
            const data = await res.json();
            
            if (data.error) return alert(data.error);
            if (data.error) return showToast(data.error, 'error');

            // Renderizar Vitals
            const v = data.vitals;
            document.getElementById('pHealth').innerText = Math.round(v.health);
            document.getElementById('pFood').innerText = v.foodLevel;
            document.getElementById('pSat').innerText = Math.round(v.foodSaturation);
            document.getElementById('pXpLvl').innerText = v.xpLevel;
            document.getElementById('pXpTotal').innerText = v.xpTotal;
            
            const pct = Math.round(v.xpProgress * 100);
            document.getElementById('pXpBar').style.width = `${pct}%`;
            document.getElementById('pXpText').innerText = `${pct}%`;
            document.getElementById('pXpMissing').innerText = `${100 - pct}%`;

            // Renderizar Botones de Acci√≥n (Inteligentes)
            const actionsDiv = document.getElementById('playerActionsBar');
            const name = currentPlayerDetails;
            
            actionsDiv.innerHTML = `
                <button onclick="sendCmd('op ${name}', '${data.isOp ? 'Quitar OP' : 'Dar OP'}')" style="flex:1; background: ${data.isOp ? '#ef4444' : '#eab308'};">${data.isOp ? 'üíî Quitar OP' : 'üëë Hacer OP'}</button>
                
                <button onclick="sendCmd('whitelist ${data.isWhitelisted ? 'remove' : 'add'} ${name}', 'Whitelist')" style="flex:1; background: ${data.isWhitelisted ? '#ef4444' : '#10b981'};">${data.isWhitelisted ? 'üìú Quitar Whitelist' : 'üìú A√±adir Whitelist'}</button>
                
                <button onclick="sendCmd('ban ${name}', 'Ban')" style="flex:1; background: #7f1d1d;">üö´ ${data.isBanned ? 'Unban' : 'Banear'}</button>
                
                <button onclick="sendCmd('ban-ip ${name}', 'IP Ban')" style="flex:1; background: #450a0a;">‚ò†Ô∏è IP-Ban</button>
            `;

            renderInventory(data.inventory, 'inventoryGrid');
            renderInventory(data.enderChest, 'enderGrid');
            renderEquipment(data.inventory);
            renderStats(data.stats);
        }

        function renderInventory(items, elementId) {
            const grid = document.getElementById(elementId);
            grid.innerHTML = '';
            
            // Crear slots: 36 para Inventario (4 filas), 27 para EnderChest (3 filas)
            const slotCount = elementId === 'inventoryGrid' ? 36 : 27;
            
            for (let i = 0; i < slotCount; i++) {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'inv-slot';
                
                // Mapeo Visual para Inventario:
                // Filas 1-3 (i=0..26) -> Slots 9-35 (Inventario Principal)
                // Fila 4 (i=27..35)   -> Slots 0-8 (Hotbar)
                let slotIndex = i;
                if (elementId === 'inventoryGrid') {
                    if (i < 27) slotIndex = i + 9;
                    else slotIndex = i - 27;
                }
                
                const item = items.find(it => it.Slot === slotIndex);

                fillSlot(slotDiv, item);
                
                grid.appendChild(slotDiv);
            }
        }

        function renderEquipment(items) {
            const armorGrid = document.getElementById('armorGrid');
            const offhandGrid = document.getElementById('offhandGrid');
            armorGrid.innerHTML = '';
            offhandGrid.innerHTML = '';

            // Armadura: 103 (Casco), 102 (Peto), 101 (Pantal√≥n), 100 (Botas)
            [103, 102, 101, 100].forEach(slotId => {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'inv-slot';
                const item = items.find(it => it.Slot === slotId);
                fillSlot(slotDiv, item);
                armorGrid.appendChild(slotDiv);
            });

            // Mano Secundaria: -106
            const slotDiv = document.createElement('div');
            slotDiv.className = 'inv-slot';
            const item = items.find(it => it.Slot === -106);
            fillSlot(slotDiv, item);
            offhandGrid.appendChild(slotDiv);
        }

        function fillSlot(slotDiv, item) {
            if (item) {
                const idClean = item.id.replace('minecraft:', '');
                slotDiv.innerHTML = `<span style="font-size: 10px; color: #fff;">${idClean.substring(0, 2).toUpperCase()}</span>`;
                if (item.Count > 1) {
                    slotDiv.innerHTML += `<span class="inv-item-count">${item.Count}</span>`;
                }
                slotDiv.innerHTML += `<div class="inv-tooltip">${idClean} x${item.Count}</div>`;
                slotDiv.style.background = '#666'; // Slot ocupado
            }
        }

        function renderStats(stats) {
            const tbody = document.getElementById('statsBody');
            tbody.innerHTML = '';
            
            // Aplanar estad√≠sticas para mostrar
            for (const category in stats) {
                for (const statName in stats[category]) {
                    const cleanStat = statName.replace('minecraft:', '').replace(/_/g, ' ');
                    const row = `<tr><td style="color: var(--text-muted);">${cleanStat}</td><td style="text-align: right;">${stats[category][statName]}</td></tr>`;
                    tbody.innerHTML += row;
                }
            }
        }

        // Helper para botones del modal
        async function sendCmd(cmd, actionName) {
            socket.emit('send-command', cmd);
            showToast(`Comando enviado: ${actionName}`, 'success');
            setTimeout(loadPlayerDetails, 1000); // Recargar para ver cambios
        }

        // --- L√≥gica de Whitelist ---
        async function loadWhitelist() {
            if(!currentServerName) return;
            const res = await fetch(`/whitelist/${currentServerName}`);
            const players = await res.json();
            
            const list = document.getElementById('whitelistDisplay');
            list.innerHTML = '';
            
            if(players.length === 0) {
                list.innerHTML = '<li style="padding: 10px; color: var(--text-muted);">La lista est√° vac√≠a o desactivada.</li>';
                return;
            }

            players.forEach(p => {
                const li = document.createElement('li');
                li.style.padding = '10px';
                li.style.borderBottom = '1px solid var(--border-color)';
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                
                li.innerHTML = `<span>üë§ ${p.name}</span> <button onclick="removeWhitelistPlayer('${p.name}')" style="background: var(--danger-color); padding: 2px 8px; font-size: 0.8em;">Eliminar</button>`;
                list.appendChild(li);
            });
        }

        async function sendWhitelistCmd(action) {
            const id = document.getElementById('containerId').value;
            await fetch(`/execute-command/${id}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ command: `whitelist ${action}` })
            });
            if(action === 'reload') setTimeout(loadWhitelist, 500);
        }

        async function addWhitelistPlayer() {
            const name = document.getElementById('whitelistInput').value;
            if(!name) return;
            await sendWhitelistCmd(`add ${name}`);
            document.getElementById('whitelistInput').value = '';
            setTimeout(loadWhitelist, 1000); // Esperar a que el servidor actualice el archivo
        }

        async function removeWhitelistPlayer(name) {
            if(confirm(`¬øSacar a ${name} de la whitelist?`)) {
                await sendWhitelistCmd(`remove ${name}`);
                setTimeout(loadWhitelist, 1000);
            }
        }

        // --- Editor de Archivos ---
        let currentEditingFile = '';

        async function loadEditorContent(serverName, fileName) {
            currentEditingFile = fileName;
            document.getElementById('editorTitle').innerText = `Editando: ${fileName}`;
            if(editor) editor.setValue("Cargando...", -1);

            try {
                const res = await fetch(`/read-file/${serverName}?fileName=${fileName}`);
                const data = await res.json();
                if (data.error) {
                    showToast(data.error, 'error');
                    showServerView('manageView');
                } else {
                    if(editor) {
                        editor.setValue(data.content, -1);
                        
                        // Detectar lenguaje para coloreado de sintaxis
                        const ext = fileName.split('.').pop().toLowerCase();
                        let mode = "ace/mode/text";
                        if(ext === 'json') mode = "ace/mode/json";
                        else if(ext === 'properties') mode = "ace/mode/properties";
                        else if(ext === 'yml' || ext === 'yaml') mode = "ace/mode/yaml";
                        else if(ext === 'toml') mode = "ace/mode/toml";
                        else if(ext === 'xml') mode = "ace/mode/xml";
                        else if(ext === 'sh') mode = "ace/mode/sh";
                        
                        editor.session.setMode(mode);
                    }
                }
            } catch (e) {
                showToast("Error cargando archivo", 'error');
                showServerView('manageView');
            }
        }

        async function saveFile() {
            if (!currentEditingFile) return;
            const content = editor ? editor.getValue() : '';
            
            // Guardado especial para Plugins
            if (currentEditingFile.startsWith('PLUGIN:')) {
                const pluginName = currentEditingFile.split(':')[1];
                try {
                    const res = await fetch(`/plugin-config/${pluginName}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content })
                    });
                    const data = await res.json();
                    showToast(data.message || data.error, res.ok ? 'success' : 'error');
                } catch (e) { showToast("Error guardando config", 'error'); }
                return;
            }

            // Guardado normal de servidor
            if (!currentServerName) return;
            
            try {
                const res = await fetch(`/save-file/${currentServerName}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileName: currentEditingFile, content })
                });
                const data = await res.json();
                showToast(data.message || data.error, res.ok ? 'success' : 'error');
            } catch (e) {
                showToast("Error guardando archivo", 'error');
            }
        }

        // --- GESTOR DE ARCHIVOS ---
        let currentPath = '';

        function openFileManager() {
            if(!currentServerName) return;
            currentPath = ''; // Reiniciar a la ra√≠z
            loadFiles();
        }

        async function loadFiles() {
            const encodedPath = encodeURIComponent(currentPath);
            const res = await fetch(`/files/${currentServerName}?path=${encodedPath}`);
            const files = await res.json();
            const tbody = document.getElementById('fileListBody');
            tbody.innerHTML = '';
            
            // Mostrar ruta actual
            document.getElementById('fileManagerPath').innerText = currentPath ? '/' + currentPath : '/';

            if(files.error) return showToast("Error listando archivos", "error");

            // Bot√≥n para volver atr√°s (..)
            if (currentPath) {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid var(--border-color)';
                tr.style.background = 'rgba(255,255,255,0.05)';
                tr.innerHTML = `<td colspan="3" style="padding: 10px; cursor: pointer;" onclick="goUpDirectory()">üîô .. (Volver)</td>`;
                tbody.appendChild(tr);
            }

            // Ordenar: Carpetas primero
            files.sort((a, b) => (a.isDirectory === b.isDirectory) ? 0 : a.isDirectory ? -1 : 1);

            files.forEach(f => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid var(--border-color)';
                
                const icon = f.isDirectory ? 'üìÅ' : 'üìÑ';
                const size = f.isDirectory ? '-' : (f.size / 1024 < 1024 ? (f.size / 1024).toFixed(1) + ' KB' : (f.size / 1024 / 1024).toFixed(1) + ' MB');
                
                // Ruta completa relativa para acciones
                const fullPath = currentPath ? currentPath + '/' + f.name : f.name;

                let nameHtml = `${icon} ${f.name}`;
                if (f.isDirectory) {
                    nameHtml = `<a href="#" onclick="enterDirectory('${f.name}')" style="color: #64b5f6; text-decoration: none; font-weight: bold;">${icon} ${f.name}</a>`;
                }

                let actions = '';
                if(!f.isDirectory) {
                    actions += `<button onclick="downloadFile('${fullPath}')" style="padding: 4px 8px; font-size: 0.8em; margin-right: 5px; background: #475569;">Descargar ‚¨áÔ∏è</button>`;
                }
                // Bot√≥n Editar (solo texto)
                if(!f.isDirectory && f.name.match(/\.(properties|json|txt|yml|yaml|log|toml)$/)) {
                    actions += `<button onclick="showServerView('configView'); loadEditorContent('${currentServerName}', '${fullPath}');" style="padding: 4px 8px; font-size: 0.8em; margin-right: 5px; background: var(--primary-color);">Editar ‚úèÔ∏è</button>`;
                }
                // Bot√≥n Borrar
                actions += `<button onclick="deleteFile('${fullPath}')" style="padding: 4px 8px; font-size: 0.8em; background: var(--danger-color);">Borrar üóëÔ∏è</button>`;

                tr.innerHTML = `
                    <td style="padding: 10px;">${nameHtml}</td>
                    <td style="text-align: right; padding: 10px; color: var(--text-muted);">${size}</td>
                    <td style="text-align: right; padding: 10px;">${actions}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function enterDirectory(folderName) {
            currentPath = currentPath ? currentPath + '/' + folderName : folderName;
            loadFiles();
        }

        function goUpDirectory() {
            if (!currentPath) return;
            const parts = currentPath.split('/');
            parts.pop();
            currentPath = parts.join('/');
            loadFiles();
        }

        function downloadFile(fileName) {
            window.location.href = `/download-file/${currentServerName}?fileName=${encodeURIComponent(fileName)}`;
        }

        async function deleteFile(fileName) {
            if(!confirm(`¬øEliminar ${fileName} permanentemente?`)) return;
            
            const res = await fetch(`/delete-file/${currentServerName}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fileName })
            });
            
            if(res.ok) {
                showToast("Archivo eliminado", "success");
                loadFiles();
            } else {
                showToast("Error eliminando archivo", "error");
            }
        }

        // L√≥gica de Drag & Drop
        const dropZone = document.getElementById('dropZone');
        const fileManagerView = document.getElementById('fileManagerView');
        
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--success-color)'; dropZone.style.background = 'rgba(16, 185, 129, 0.1)'; });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--border-color)'; dropZone.style.background = 'rgba(0,0,0,0.2)'; });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--border-color)'; dropZone.style.background = 'rgba(0,0,0,0.2)'; handleFiles(e.dataTransfer.files); });
        // Permitir arrastrar en todo el modal para subir al directorio actual
        fileManagerView.addEventListener('dragover', (e) => { 
            e.preventDefault(); 
            e.stopPropagation();
            dropZone.style.borderColor = 'var(--success-color)'; 
            dropZone.style.background = 'rgba(16, 185, 129, 0.1)'; 
        });
        
        fileManagerView.addEventListener('dragleave', (e) => { 
            e.preventDefault(); 
            e.stopPropagation();
            if (!e.relatedTarget || !fileManagerView.contains(e.relatedTarget)) {
                dropZone.style.borderColor = 'var(--border-color)'; 
                dropZone.style.background = 'rgba(0,0,0,0.2)'; 
            }
        });
        
        fileManagerView.addEventListener('drop', (e) => { 
            e.preventDefault(); 
            e.stopPropagation();
            dropZone.style.borderColor = 'var(--border-color)'; 
            dropZone.style.background = 'rgba(0,0,0,0.2)'; 
            handleFiles(e.dataTransfer.files); 
        });

        function handleFiles(files) {
            if(!files.length) return;
            const formData = new FormData();
            for(let i=0; i<files.length; i++) formData.append('files', files[i]);

            const progressContainer = document.getElementById('uploadProgressContainer');
            const progressBar = document.getElementById('uploadProgressBar');
            
            if(progressContainer) {
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
            }

            showToast("Subiendo archivos...", "info");
            
            const xhr = new XMLHttpRequest();
            const encodedPath = encodeURIComponent(currentPath);
            xhr.open('POST', `/upload/${currentServerName}?path=${encodedPath}`, true);

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    if(progressBar) progressBar.style.width = percent + '%';
                }
            };

            xhr.onload = () => {
                if(xhr.status === 200) { showToast("Archivos subidos correctamente", "success"); loadFiles(); }
                else { showToast("Error en la subida", "error"); }
                if(progressContainer) setTimeout(() => progressContainer.style.display = 'none', 1000);
            };

            xhr.onerror = () => { showToast("Error de red", "error"); if(progressContainer) progressContainer.style.display = 'none'; };
            
            xhr.send(formData);
        }

        // --- Sistema de Notificaciones Toast Mejorado ---
        function showToast(message, type = 'info') { // types: info, success, error
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let bgColor;
            switch(type) {
                case 'success': bgColor = '#4CAF50'; break;
                case 'error': bgColor = '#d9534f'; break;
                default: bgColor = '#1793d1';
            }
            toast.style.cssText = `background: ${bgColor}; color: white; padding: 15px; margin-bottom: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); min-width: 250px; transition: all 0.5s ease; opacity: 0; transform: translateX(20px);`;
            toast.innerHTML = `${message}`;
            container.appendChild(toast);
            
            setTimeout(() => { toast.style.opacity = '1'; toast.style.transform = 'translateX(0)'; }, 10);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 4000);
        }

        // --- Sistema de Notificaciones ---
        function showNotification(title, body) {
            showToast(`<strong>${title}</strong><br>${body}`, 'error');

            // 2. Notificaci√≥n del Navegador
            if (Notification.permission === "granted") {
                new Notification(title, { body });
            }
        }

        // --- Cat√°logo de Versiones (Fabric API) ---
        async function checkServerType() {
            const type = document.getElementById('serverType').value;
            const loaderField = document.getElementById('fabricLoaderField');
            const versionInput = document.getElementById('serverVersion');
            const datalist = document.getElementById('commonVersions');
            
            if (type === 'FABRIC') {
                loaderField.style.display = 'block';
                versionInput.placeholder = "Cargando cat√°logo de Fabric...";
                
                // 1. Obtener versiones de Minecraft compatibles con Fabric
                try {
                    const res = await fetch('https://meta.fabricmc.net/v2/versions/game');
                    const data = await res.json();
                    datalist.innerHTML = ''; // Limpiar lista
                    data.forEach(v => {
                        if(v.stable) {
                            const opt = document.createElement('option');
                            opt.value = v.version;
                            datalist.appendChild(opt);
                        }
                    });
                    versionInput.placeholder = "Selecciona versi√≥n (ej: 1.20.1)";
                } catch(e) { console.error("Error cargando versiones game:", e); }

                // 2. Obtener versiones del Loader
                try {
                    const res = await fetch('https://meta.fabricmc.net/v2/versions/loader');
                    const data = await res.json();
                    const loaderSelect = document.getElementById('serverLoaderVersion');
                    loaderSelect.innerHTML = '';
                    data.forEach(l => {
                        if(l.stable) {
                            const opt = document.createElement('option');
                            opt.value = l.version;
                            opt.innerText = `Loader ${l.version}`;
                            loaderSelect.appendChild(opt);
                        }
                    });
                } catch(e) { console.error("Error cargando loaders:", e); }

            } else {
                loaderField.style.display = 'none';
                // Restaurar lista por defecto
                datalist.innerHTML = `
                    <option value="LATEST">√öltima Versi√≥n Estable</option>
                    <option value="1.21.1">1.21.1 (Tricky Trials)</option>
                    <option value="1.21">1.21</option>
                    <option value="1.20.6">1.20.6 (Armored Paws)</option>
                    <option value="1.20.4">1.20.4 (Trails & Tales)</option>
                    <option value="1.20.1">1.20.1 (Popular)</option>
                    <option value="1.19.4">1.19.4 (The Wild Update)</option>
                    <option value="1.19.2">1.19.2</option>
                    <option value="1.18.2">1.18.2 (Caves & Cliffs II)</option>
                    <option value="1.17.1">1.17.1 (Caves & Cliffs I)</option>
                    <option value="1.16.5">1.16.5 (Nether Update - Mods)</option>
                    <option value="1.15.2">1.15.2 (Buzzy Bees)</option>
                    <option value="1.14.4">1.14.4 (Village & Pillage)</option>
                    <option value="1.13.2">1.13.2 (Update Aquatic)</option>
                    <option value="1.12.2">1.12.2 (Classic Mods)</option>
                    <option value="1.8.9">1.8.9 (PvP Legacy)</option>
                    <option value="1.7.10">1.7.10 (Legendary Mods)</option>
                `;
            }
        }

        window.onload = () => {
            showDashboard();
            
            // Inicializar Ace Editor
            ace.config.set('basePath', 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/');
            editor = ace.edit("fileEditorContent");
            editor.setTheme("ace/theme/dracula"); // Tema oscuro estilo VS Code
            editor.session.setMode("ace/mode/text");
            editor.setShowPrintMargin(false);
            editor.setOptions({
                fontFamily: "'JetBrains Mono', monospace",
                fontSize: "14px"
            });

            // Atajo de teclado: Ctrl + S para guardar
            editor.commands.addCommand({
                name: 'save',
                bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
                exec: function(editor) {
                    saveFile();
                }
            });

            // Cargar Plugins Web
            loadWebPlugins();
        };

        async function loadWebPlugins() {
            try {
                const res = await fetch('/list-web-plugins');
                const scripts = await res.json();
                scripts.forEach(src => {
                    const script = document.createElement('script');
                    script.src = src;
                    document.body.appendChild(script);
                    console.log('üîå Plugin web cargado:', src);
                });
            } catch (e) {
                console.error("Error cargando plugins web:", e);
            }
        }
    </script>
</body>
</html>